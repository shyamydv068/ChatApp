# Malware Analysis: Techniques, Tools, Commands, and Best Practices

This README is an actionable guide for SOC analysts and malware researchers. It covers analysis techniques, common malware behaviors, recommended tools, command examples (Windows & Linux), workflows, unpacking tips, memory & network analysis, IOC extraction, and reporting. Use this as a reference during triage and deeper analysis.

> WARNING: Always analyze malware in an isolated, offline environment (air-gapped VM or sandbox) and follow your organization's legal/policy guidance. Never run suspicious samples on production or internet-connected hosts.

---

## Table of Contents
- Overview
- Safe environment & setup
- Types of malware & common techniques used by malware
- Analysis techniques (what they are, when to use)
  - Static analysis
  - Dynamic analysis (behavioral)
  - Memory forensics
  - Network analysis
  - Hybrid / automated sandboxing
- Tools catalog (quick reference)
- Example commands & usage (copyable)
- Workflows / playbooks (step-by-step)
- Unpacking & deobfuscation tips
- IOC extraction & enrichment
- Detection rules & YARA examples
- Mapping to MITRE ATT&CK
- Reporting & evidence collection
- Quick cheat-sheet (one-page)
- References & further reading

---

## Overview
Malware analysis is the process of understanding what a malicious sample does, how it persists, communicates, and what artifacts/IOCs it leaves. Typical goals:
- Determine capabilities (info-steal, ransomware, botnet, dropper).
- Extract IOCs to block & hunt (domains, IPs, hashes, mutexes, registry keys).
- Create detection signatures (YARA, Suricata, Sigma).
- Provide remediation steps and attribution where possible.

---

## Safe environment & setup
- Use isolated VMs (snapshots), no real credentials, and restricted network (DNS sinkhole or capture-only).
- Recommended distributions / kits:
  - REMnux (Linux reverse-engineering toolkit): https://remnux.org
  - FLARE VM (Windows analysis VM): https://github.com/mandiant/flare-vm
  - Cuckoo Sandbox: https://cuckoosandbox.org
- Network: simulate Internet where needed (proxy, fake services) or route through capturing network (tcpdump/Wireshark/tshark) and sandboxed proxies (mitmproxy).
- Logging: enable host and guest logging, take disk/VM snapshots before and after runs.
- Have a dedicated analysis workstation and a separate reporting system.

---

## Types of malware & common techniques
- Ransomware: file encryption + ransom notes, uses file discovery + persistence.
- Remote Access Trojans (RATs): backdoor + remote control / C2.
- Information stealers / credential harvesters: exfiltrate credentials, cookies, tokens.
- Dropper / Downloader: first-stage payload that fetches second-stage malware.
- Fileless malware: lives in memory; uses WMI, PowerShell, or scripting.
- Bootkits/rootkits: hide at boot or kernel level.
- Botnets: mass infection + command & control frameworks.
Common techniques used by malware:
- Code obfuscation / packing / encryption (UPX, custom packers)
- Anti-analysis / anti-VM / anti-debug checks (checking processes, MAC addresses, VM artifacts)
- API-level hooking & process injection
- Persistence mechanisms (services, scheduled tasks, run keys, WMI events)
- C2 communication (HTTP/S, HTTP(s) POST, DNS tunneling, custom TCP)
- Living-off-the-land (LOLbins: PowerShell, certutil, rundll32)
- Lateral movement (pass-the-hash, SMB abuse)

---

## Analysis techniques (what & when)

### Static analysis
- Goal: Identify file type, strings, imports, metadata, and obvious IOCs without execution.
- Use for initial triage and to build hypotheses.
- Tools: `file`, `strings`, `binwalk`, `pefile` (Python), `exiftool`, `7z` to inspect archives, `oletools` for Office.
- Limitations: can't see runtime behavior or unpacked payloads if packed/obfuscated.

### Dynamic (behavioral) analysis
- Goal: Execute sample in controlled environment to observe filesystem, processes, network, registry, API calls, dropped files.
- Tools: Procmon (Windows), Process Explorer, Sysinternals suite, strace/ltrace (Linux), API monitors, sandboxing (Cuckoo, Any.Run).
- Capture: Process tree, DLLs loaded, mutexes, files created, registry changes, network connections.

### Memory forensics
- Goal: Analyze volatile memory to find unpacked payloads, injected code, decrypted strings, credentials, or network artifacts.
- Tools: Volatility3, Rekall, `dumpit` or `FTK Imager` to capture memory.
- Commands: `volatility3 -f mem.raw windows.pslist.PsList` etc.

### Network analysis
- Goal: Observe C2 traffic, exfiltration, DNS patterns, beaconing behavior, HTTP/S POST destinations, TLS certs.
- Tools: Wireshark, tshark, tcpdump, Zeek (Bro), Suricata, mitmproxy, Fiddler.
- Capture location: host or border sensor; analyze pcap with filters for suspicious endpoints.

### Hybrid / sandboxed automation
- Use a sandbox (Cuckoo, Any.Run) to run samples and get automated behavioral reports, screenshots, network activity, and IOCs.

---

## Tools catalog (high level)
- Static & binary analysis:
  - file, strings, binwalk, hexdump
  - pefile (Python), lief, radare2, Ghidra, IDA Pro (disassembler)
  - olevba (oletools) for Office macros
- Dynamic analysis & system monitoring:
  - Procmon, Process Explorer, Autoruns, Sysmon, Wireshark, tcpdump, mitmproxy, Fiddler
- Memory forensics:
  - Volatility3 (https://github.com/volatilityfoundation/volatility3)
  - Rekall (https://www.rekall-forensic.com)
- Sandboxes & platforms:
  - Cuckoo Sandbox, Any.Run, Hybrid Analysis
- Threat intel & enrichment:
  - VirusTotal, URLScan.io, PassiveTotal, OTX
- Detection & hunting:
  - YARA (https://virustotal.github.io/yara/), Suricata, Zeek
- Collections / distros:
  - REMnux, FLARE VM

---

## Example commands & quick usage

Note: replace sample filenames, domains, and IPs with your artifacts.

General
- Hashing:
  - Linux/macOS: sha256sum sample.bin
  - Windows (PowerShell): Get-FileHash .\sample.exe -Algorithm SHA256

Static analysis
- Identify file type:
  - file sample.bin
- Strings extraction:
  - strings -a -n 8 sample.exe | less
- PE import & header info (Linux):
  - pefile via Python or otool on mac
- Inspect Office macros:
  - olevba suspicious.docm

Archive & firmware
- Inspect packed files / archives:
  - 7z l suspicious.zip
  - binwalk firmware.bin

Disassembly & reversing
- radare2 quick info:
  - rizin -v sample.bin  (or r2)
- Ghidra: open GUI and import sample (see Ghidra docs)
- IDA: open sample in IDA Pro

Dynamic (Windows)
- Sysinternals live:
  - procmon.exe (capture events)
  - procexp.exe (inspect process tree)
  - autoruns.exe (persistence points)
- PowerShell execution (in safe VM only):
  - Start-Process -FilePath .\sample.exe
- Dump strings of running process with Sysinternals strings or use procdump:
  - procdump -ma <pid> dump.dmp

Dynamic (Linux)
- Run under strace/ltrace:
  - strace -ff -o trace.out ./sample
  - ltrace -o ltrace.out ./sample

Network capture & analysis
- Capture traffic:
  - tcpdump -i eth0 -w capture.pcap host suspicious.example.com
- Read pcap:
  - tshark -r capture.pcap -Y "http || dns" -V

Memory forensics
- Snapshot memory (Windows):
  - use DumpIt or built-in tooling to create memory dump mem.raw
- Volatility (example):
  - volatility3 -f mem.raw windows.pslist.PsList
  - volatility3 -f mem.raw windows.malfind.Malfind
- Extract network connections from memory:
  - volatility3 -f mem.raw windows.netstat.Netstat

YARA scanning
- yara -r rules.yar samples/

Sandbox & automation
- cuckoo submit sample:
  - cuckoo submit sample.exe
- Any.Run: upload via web UI

Binary unpacking & deobfuscation
- Use binwalk, upx -d for UPX, unpackers, or manual unpacking with debugger.

---

## Workflows / Playbooks

High-level triage (5-10 minutes)
1. Collect artifacts:
   - Sample (original file), raw email (if phishing), URLs, screenshots.
   - Hash sample: SHA256, SHA1, MD5.
2. Quick static checks:
   - file, strings, check headers/imports, check whether packed (entropy check).
   - Check VT/URLScan for reputation.
3. Decide action:
   - If known-malicious: block indicators & escalate.
   - If unknown/suspicious: proceed to dynamic analysis in sandbox.
4. Run in sandbox (no credentials):
   - Capture network, filesystem, process traces.
5. Extract IOCs and create ticket/report.

Deep analysis (hours-days)
1. Create baseline snapshot and isolate VM.
2. Static reversing (disassembly, identify packer/obfuscation).
3. If packed, try automated unpackers (UPX) or dynamic unpacking with debugger.
4. Dynamic debugging to trace control flow, find decryption routine, or identify C2 protocol.
5. Memory analysis to extract decrypted payload and strings.
6. Network protocol analysis and imitation (replay traffic if needed).
7. Create detection rules (YARA) and signatures for your environment.
8. Share IOCs and write full report with TTPs and MITRE ATT&CK mapping.

---

## Unpacking & deobfuscation tips
- Check entropy:
  - Use Python or binwalk to detect high entropy (likely packed or encrypted).
- Common packers:
  - UPX: try `upx -d sample.exe`
  - If that fails, identify packer via PEiD signatures or `detectit` in radare2.
- Manual unpacking:
  - Use a debugger (x64dbg, Windbg) and set breakpoints near entry point, or monitor memory writes to detect unpacked code and dump memory.
- For .NET:
  - Use dnSpy, ILSpy to decompile managed code.
- For scripts & PowerShell:
  - Look for base64 strings, concatenation, and obfuscated cmdlets. Use `strings` and `paste` into a safe deobfuscator or PowerShell deobfuscation tools in a safe environment.

---

## IOC extraction & enrichment
- Extract:
  - Domains, URLs, IPs, hashes, registry keys, scheduled task names, mutex names, filenames, services.
- Enrich:
  - VirusTotal, PassiveTotal, WHOIS, ASN lookup, crt.sh (certificate transparency), URLScan.
- Pivot:
  - Passive DNS to find related domains; graphing tools (Maltego, Graphistry, Neo4j) to map campaign infrastructure.

---

## Detection rules & YARA example

Simple YARA rule to detect suspicious strings (example):
```yara
rule Suspicious_RAT_Sample {
    meta:
        author = "SOC Team"
        description = "Detects simple RAT indicators"
        reference = "Example"
    strings:
        $s1 = "POST /api/heartbeat" ascii
        $s2 = "User-Agent: Mozilla/5.0 (Windows NT" ascii
        $s3 = "CreateRemoteThread" ascii
    condition:
        (any of ($s*)) and filesize < 5MB
}
```

Suricata signature (HTTP POST beacon example):
```
alert http any any -> any any (msg:"Possible RAT beacon POST"; content:"POST /api/heartbeat"; nocase; sid:1000001; rev:1;)
```

Sigma rule (detect PowerShell encoded command — sample idea):
- Use Sigma rule templates in your detections framework to hunt PowerShell one-liners, download cradles, and suspicious command-line executions.

---

## Mapping to MITRE ATT&CK
Document observed TTPs and map to ATT&CK techniques (examples):
- T1059 Command and Scripting Interpreter (PowerShell)
- T1053 Scheduled Task/Job (persistence)
- T1105 Ingress Tool Transfer (downloaders)
- T1110 Brute Force (credential access)
- T1547 Boot or Logon Autostart Execution (persistence)

Mapping helps communicate risk and supports automated reporting.

---

## Reporting & evidence collection (SOC ticket)
Minimum artifacts to include in a ticket:
- SHA256, filename, sample location (secure store), and time collected
- Raw email (if phishing), headers, and screenshots
- All IOCs: domains, IPs, URLs, file paths, registry keys, mutexes
- Summary of capabilities and severity (High/Medium/Low)
- Timeline of user actions and host events
- Recommended containment steps:
  - Isolate affected hosts, rotate credentials, block domains/IPs, run AV scans, check for lateral movement
- Attach: memory dumps, pcap files, procmon logs, sandbox report

---

## Quick cheat-sheet (commands)

Hashing:
- sha256sum sample.bin
- PowerShell: Get-FileHash .\sample.exe -Algorithm SHA256

Static:
- file sample.bin
- strings -a -n 8 sample.exe | less
- olevba suspicious.docm

Network:
- tcpdump -i eth0 -w capture.pcap host suspicious.example.com
- tshark -r capture.pcap -Y "http.request" -T fields -e http.host -e http.request.uri

Memory & volatility:
- volatility3 -f mem.raw windows.pslist.PsList
- volatility3 -f mem.raw windows.malfind.Malfind

YARA:
- yara -r rules.yar samples/

Sandbox:
- cuckoo submit sample.exe

---

## Common pitfalls & safety reminders
- Don't rely solely on VirusTotal — it's a signal, not proof.
- Be careful with public sandboxes and samples containing PII.
-
